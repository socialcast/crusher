#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join( File.dirname(__FILE__) + "/../lib" )
require 'crusher'

config = Crusher::Configurator::Configuration.new('.crusher')

target_name = ARGV[0].to_sym
scenario_name = ARGV[1].to_sym

target = config.targets[target_name]
scenario = config.scenarios[scenario_name]

puts "Fatal Error: Unknown target '#{target_name}'" unless target
puts "Fatal Error: Unknown scenario '#{scenario_name}'" unless scenario 
exit(1) unless target && scenario

options = {}
options[:end_time] = Time.now + scenario.duration
options[:log_file] = ARGV[2]

scenario.launch_jobs.each do |job|
  job_id = 0
  puts "Launching #{job[:count]} #{job[:type]}(s)..."
  
  job[:count].times do
    fork do
      options[:process_name] = "#{job[:type]} #{job_id}"
      job[:proc].call(target, scenario, options, job_id)
      exit(0)
    end
    job_id += 1
  end
  
end

